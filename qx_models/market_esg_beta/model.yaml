model:
  id: market_esg_beta_model
  version: 1.0.0
  featureset_id: ohlcv_v1+esg_factors_v1+rf_v1
  description: |
    Market + ESG Two-Factor OLS Regression:

    Estimates factor exposures (betas) and Jensen's alpha using OLS regression:
      Excess_Return = α + β_market * Market_Excess + β_ESG * ESG_Factor + ε

    Where:
      - Excess returns subtract risk-free rate
      - Market excess: SPY returns minus risk-free rate
      - ESG factor: Long-short ESG portfolio returns
      - Betas measure sensitivity to each factor
      - Alpha measures abnormal return (not explained by factors)

    Statistical Inference:
      - Uses Newey-West (HAC) standard errors
      - Corrects for autocorrelation and heteroskedasticity
      - Provides t-statistics and p-values for significance testing

    Output:
      - Cross-sectional (one beta per stock) if window=null
      - Time-series (rolling betas) if window specified

inputs:
  # Input 1: Stock prices (for individual stock returns)
  - name: equity_prices
    required: true
    type:
      domain: market-data
      asset_class: equity
      subdomain: bars
      region: null
      frequency: monthly
    description: "Monthly stock OHLCV data for calculating returns"

  # Input 2: Market prices (SPY for market returns)
  - name: market_prices
    required: true
    type:
      domain: market-data
      asset_class: equity
      subdomain: bars
      region: null
      frequency: monthly
    description: "Monthly SPY bar data (market proxy)"

  # Input 3: ESG factors (from ESGFactorModel in processed storage)
  # Note: Set required=false because this comes from processed storage, not curated
  # Model will load manually from processed storage using run_id
  - name: esg_factors
    required: false
    type:
      domain: derived-metrics
      asset_class: equity
      subdomain: factor-returns
      subtype: esg-factors
      region: null
      frequency: monthly
    description: "Monthly ESG factor returns (output from ESGFactorModel in processed storage)"

  # Input 4: Risk-free rate
  - name: risk_free
    required: true
    type:
      domain: reference-rates
      asset_class: fixed-income
      subdomain: yield-curves
      region: US
      frequency: monthly
    description: "Monthly risk-free rates"

output:
  type:
    domain: derived-metrics
    asset_class: equity
    subdomain: factor-exposures
    subtype: market-esg-regression
    region: null
    frequency: monthly
  description: |
    Factor exposures (betas) and alpha from two-factor regression.

    Cross-sectional output (window=null):
      - One row per stock with full-sample estimates
      - Columns: symbol, alpha, beta_market, beta_esg, statistics

    Time-series output (window specified):
      - Multiple rows per stock (rolling window estimates)
      - Columns: symbol, date, alpha, beta_market, beta_esg, statistics

  # Schema definition
  schema:
    schema_version: schema_v1

    columns:
      - name: symbol
        type: string
        description: Stock ticker symbol
        required: true
        filterable: true
        filter_type: in

      - name: date
        type: date
        description: Regression end date (cross-sectional = end of sample, time-series = window end)
        required: true
        filterable: true
        filter_type: range

      - name: alpha
        type: float
        description: Jensen's alpha - abnormal return (monthly decimal)
        required: true
        filterable: true
        filter_type: range

      - name: beta_market
        type: float
        description: Market beta - sensitivity to market factor
        required: true
        filterable: true
        filter_type: range

      - name: beta_esg
        type: float
        description: ESG beta - sensitivity to ESG factor
        required: true
        filterable: true
        filter_type: range

      - name: alpha_tstat
        type: float
        description: Alpha t-statistic
        required: true
        filterable: false

      - name: beta_market_tstat
        type: float
        description: Market beta t-statistic
        required: true
        filterable: false

      - name: beta_esg_tstat
        type: float
        description: ESG beta t-statistic
        required: true
        filterable: false

      - name: alpha_pvalue
        type: float
        description: Alpha p-value
        required: true
        filterable: true
        filter_type: range

      - name: beta_market_pvalue
        type: float
        description: Market beta p-value
        required: true
        filterable: true
        filter_type: range

      - name: beta_esg_pvalue
        type: float
        description: ESG beta p-value
        required: true
        filterable: true
        filter_type: range

      - name: r_squared
        type: float
        description: R² - goodness of fit
        required: true
        filterable: true
        filter_type: range

      - name: adj_r_squared
        type: float
        description: Adjusted R²
        required: true
        filterable: true
        filter_type: range

      - name: f_statistic
        type: float
        description: F-statistic for joint significance
        required: true
        filterable: false

      - name: f_pvalue
        type: float
        description: F-statistic p-value
        required: true
        filterable: true
        filter_type: range

      - name: observations
        type: int
        description: Number of observations used in regression
        required: true
        filterable: true
        filter_type: range

      - name: std_error_alpha
        type: float
        description: Standard error of alpha (HAC-robust)
        required: true
        filterable: false

      - name: std_error_beta_market
        type: float
        description: Standard error of market beta (HAC-robust)
        required: true
        filterable: false

      - name: std_error_beta_esg
        type: float
        description: Standard error of ESG beta (HAC-robust)
        required: true
        filterable: false

      - name: model
        type: string
        description: Model ID (auto-added by BaseModel)
        required: true
        filterable: true
        filter_type: in

      - name: model_version
        type: string
        description: Model version (auto-added by BaseModel)
        required: true
        filterable: false

      - name: featureset_id
        type: string
        description: Input featureset ID (auto-added by BaseModel)
        required: true
        filterable: false

      - name: run_id
        type: string
        description: Unique run identifier (auto-added by BaseModel)
        required: true
        filterable: false

      - name: run_ts
        type: string
        description: Run timestamp ISO 8601 (auto-added by BaseModel)
        required: true
        filterable: true
        filter_type: range

    partition_keys:
      - output_type
      - model
      - run_date

    filters:
      symbol_list:
        columns: [symbol]
        type: in
        description: Filter to specific symbols
        example: ["AAPL", "MSFT", "GOOGL"]

      date_range:
        columns: [date]
        type: range
        description: Filter by regression end date range
        example: ["2020-01-01", "2024-12-31"]

      beta_market_range:
        columns: [beta_market]
        type: range
        description: Filter by market beta range
        example: [0, 2]

      significant_alpha:
        columns: [alpha_pvalue]
        type: range
        description: Filter for significant alpha (p-value < 0.05)
        example: [0, 0.05]

    path_template: data/processed/{output_type}/model={model}/run_date={run_date}

parameters:
  esg_factor_name:
    type: enum
    default: "ESG"
    allowed: ["ESG", "E", "S", "G", "ESG_mom"]
    description: |
      Which ESG factor to use in the regression.
      - ESG: Composite ESG score factor (default)
      - E/S/G: Individual pillar factors
      - ESG_mom: ESG momentum factor

  window_size:
    type: int
    default: null
    min: 36
    max: 120
    description: |
      Rolling window size in months (null = full sample).
      - null: Single cross-sectional regression (one beta per stock)
      - 36-120: Rolling window (time-series of betas)
      Minimum 36 months for statistical robustness.

  min_observations:
    type: int
    default: 36
    min: 24
    max: 60
    description: |
      Minimum number of monthly observations required.
      Default 36 = 3 years (standard for monthly factor models)

  use_hac_se:
    type: bool
    default: true
    description: |
      Use Newey-West (HAC) standard errors.
      - true: Corrects for autocorrelation and heteroskedasticity (recommended)
      - false: Use OLS standard errors (assumes i.i.d. errors)

  hac_maxlags:
    type: int
    default: 12
    min: 1
    max: 24
    description: |
      Maximum lags for Newey-West HAC covariance.
      Default 12 for monthly data (captures annual seasonality).
      Rule: floor(4 * (T/100)^(2/9)) per Newey & West (1994)

metadata:
  author: Qx System
  created: 2025-12-04
  tags:
    - regression
    - factor-models
    - market-beta
    - esg-beta
    - ols

  references:
    - "Fama & French (1993): Common risk factors in the returns on stocks and bonds"
    - "Carhart (1997): On persistence in mutual fund performance"
    - "Pastor, Stambaugh & Taylor (2021): Sustainable investing in equilibrium"
    - "Newey & West (1987): A simple, positive semi-definite, heteroskedasticity and autocorrelation consistent covariance matrix"

  notes: |
    This model migrates from legacy TwoFactorRegression (src/programs/two_factor_regression.py)
    to the Qx BaseModel architecture.

    Key improvements:
    - Declarative configuration (model.yaml)
    - Automatic input loading from processed ESG factors
    - Type-safe dataset contracts
    - Supports both cross-sectional and time-series analysis

    Interpretation:
    - α (alpha): Abnormal return not explained by factors (monthly)
    - β_market: Sensitivity to market movements (1.0 = market average)
    - β_ESG: Sensitivity to ESG factor (positive = ESG tilt)
    - Statistical significance: t-stat >2 or p-value <0.05
