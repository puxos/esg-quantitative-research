model:
  id: esg_factor_model
  version: 1.0.0
  featureset_id: ohlcv_v1+esg_v1+rf_v1
  description: |
    Construct ESG long-short factor portfolios based on ESG scores and momentum signals.

    Factor Construction:
    - ESG Factor: Long-short portfolio based on ESG composite scores
    - E/S/G Factors: Long-short portfolios based on individual pillar scores
    - ESG Momentum Factor: Long-short portfolio based on changes in ESG scores

    Portfolio Construction:
    - Ranks stocks by signal (cross-sectional or sector-neutral)
    - Long top quantile (e.g., top 20%)
    - Short bottom quantile (e.g., bottom 20%)
    - Equal-weighted or value-weighted legs
    - Signal at t-1 used to form portfolios earning returns at t

    Timing Convention:
    - Uses 12-month ESG lag to avoid look-ahead bias
    - Month t ESG score → used for month t+12 trading
    - Conservative: maximizes lag, minimizes look-ahead risk

inputs:
  # Input 1: Price data (curated) - for returns calculation
  - name: equity_prices
    required: true
    type:
      domain: market-data
      asset_class: equity
      subdomain: bars
      region: null
      frequency: null
    description: "Monthly OHLCV price data (specify region and frequency in partitions)"

  # Input 2: ESG scores (curated)
  - name: esg_scores
    required: true
    type:
      domain: esg
      asset_class: equity
      subdomain: esg-scores
      region: null
      frequency: yearly
    description: "Annual ESG scores (esg_year with 'year' column for availability)"

  # Input 3: Risk-free rate (curated)
  - name: risk_free
    required: true
    type:
      domain: reference-rates
      asset_class: fixed-income
      subdomain: yield-curves
      region: null
      frequency: monthly
    description: "Monthly risk-free rates (specify region and frequency in partitions)"

output:
  # Dataset identity
  type:
    domain: derived-metrics
    asset_class: equity
    subdomain: factor-returns
    subtype: esg-factors
    region: null
    frequency: monthly

  # Schema definition
  schema:
    schema_version: schema_v1

    columns:
      - name: date
        type: date
        description: Monthly observation date
        required: true
        filterable: true
        filter_type: range

      # ESG Factor (composite score)
      - name: ESG_long
        type: float
        description: ESG factor long leg return
        required: false
        filterable: true
        filter_type: range

      - name: ESG_short
        type: float
        description: ESG factor short leg return
        required: false
        filterable: true
        filter_type: range

      - name: ESG_factor
        type: float
        description: ESG factor long-short return
        required: false
        filterable: true
        filter_type: range

      # Environmental Factor
      - name: E_long
        type: float
        description: Environmental factor long leg return
        required: false
        filterable: true
        filter_type: range

      - name: E_short
        type: float
        description: Environmental factor short leg return
        required: false
        filterable: true
        filter_type: range

      - name: E_factor
        type: float
        description: Environmental factor long-short return
        required: false
        filterable: true
        filter_type: range

      # Social Factor
      - name: S_long
        type: float
        description: Social factor long leg return
        required: false
        filterable: true
        filter_type: range

      - name: S_short
        type: float
        description: Social factor short leg return
        required: false
        filterable: true
        filter_type: range

      - name: S_factor
        type: float
        description: Social factor long-short return
        required: false
        filterable: true
        filter_type: range

      # Governance Factor
      - name: G_long
        type: float
        description: Governance factor long leg return
        required: false
        filterable: true
        filter_type: range

      - name: G_short
        type: float
        description: Governance factor short leg return
        required: false
        filterable: true
        filter_type: range

      - name: G_factor
        type: float
        description: Governance factor long-short return
        required: false
        filterable: true
        filter_type: range

      # ESG Momentum Factor
      - name: ESG_mom_long
        type: float
        description: ESG momentum factor long leg return
        required: false
        filterable: true
        filter_type: range

      - name: ESG_mom_short
        type: float
        description: ESG momentum factor short leg return
        required: false
        filterable: true
        filter_type: range

      - name: ESG_mom_factor
        type: float
        description: ESG momentum factor long-short return
        required: false
        filterable: true
        filter_type: range

      - name: model
        type: string
        description: Model ID (auto-added by BaseModel)
        required: true
        filterable: true
        filter_type: in

      - name: model_version
        type: string
        description: Model version (auto-added by BaseModel)
        required: true
        filterable: false

      - name: featureset_id
        type: string
        description: Input featureset ID (auto-added by BaseModel)
        required: true
        filterable: false

      - name: run_id
        type: string
        description: Unique run identifier (auto-added by BaseModel)
        required: true
        filterable: false

      - name: run_ts
        type: string
        description: Run timestamp ISO 8601 (auto-added by BaseModel)
        required: true
        filterable: true
        filter_type: range

    filters:
      date_range:
        columns: [date]
        type: range
        description: Filter by observation date range
        example: ["2020-01-01", "2024-12-31"]

      factor_list:
        columns: [factor_name]
        type: in
        description: Filter to specific factors
        example: ["ESG", "E", "S"]

      return_range:
        columns: [factor_return]
        type: range
        description: Filter by factor return range
        example: [-0.05, 0.05]

  # Partition and path configuration
  partition_keys:
    - output_type
    - model
    - run_date

  path_template: data/processed/{output_type}/model={model}/run_date={run_date}

  description: |
    Monthly ESG factor returns (excess returns, risk-free adjusted).

    Output columns: date, factor_name, factor_return, long_return, short_return

    Factor names:
    - ESG: Composite ESG score factor
    - E: Environmental pillar factor
    - S: Social pillar factor
    - G: Governance pillar factor
    - ESG_mom: ESG momentum factor (YoY changes)

parameters:
  quantile:
    type: float
    default: 0.2
    min: 0.05
    max: 0.5
    description: "Quantile for long/short legs (0.2 = top/bottom 20%)"

  sector_neutral:
    type: bool
    default: false
    description: "Whether to rank within sectors (true) or cross-sectional (false)"

  lag_signal:
    type: int
    default: 1
    min: 0
    max: 12
    description: "Number of periods to lag signal (default: 1 month)"

  weighting:
    type: enum
    default: "equal"
    allowed: ["equal", "value"]
    description: |
      Portfolio weighting scheme:
      - equal: Each stock gets 1/N weight (academic standard)
      - value: Market cap weighted (practitioner standard)

  esg_annual_lag:
    type: int
    default: 12
    min: 0
    max: 24
    description: |
      Months to lag ESG scores to avoid look-ahead bias.
      Default 12 = conservative 1-year lag (month t-12 score → month t trading)

  return_legs:
    type: bool
    default: true
    description: "Whether to return separate long/short leg returns (for analysis)"

metadata:
  author: Qx System
  created: 2025-12-04
  tags:
    - esg
    - factors
    - long-short
    - portfolio

  references:
    - "Luo & Balvers (2017): Social screens and systematic investor boycott risk"
    - "Pastor, Stambaugh & Taylor (2021): Sustainable investing in equilibrium"
    - "Fama & French (1993): Common risk factors in returns on stocks and bonds"

  notes: |
    This model migrates from legacy ESGFactorBuilder (src/esg/esg_factor.py)
    to the Qx BaseModel architecture.

    Key improvements:
    - Declarative configuration (model.yaml)
    - Automatic input loading and output writing
    - Type-safe dataset contracts
    - Integrated with Qx pipeline system

    Timing Convention:
    - ESG scores lagged by 12 months (uniform shift)
    - Avoids look-ahead bias while maintaining calendar-year mapping
    - Conservative approach standard in academic factor research
