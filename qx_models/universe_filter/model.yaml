model:
  id: universe_filter
  version: 1.0.0
  featureset_id: esg_scores_v1+membership_v1
  description: |
    Universe Filter Model: Filter to tickers with continuous ESG score coverage.

    This model analyzes ESG score availability for a universe of tickers over
    a specified research period and filters to tickers meeting data quality
    requirements for quantitative analysis.

    Purpose:
      - Ensure tickers have sufficient ESG score history
      - Identify gaps in ESG coverage that could bias research
      - Produce reproducible, auditable universe filtering

    Use Case:
      Before building ESG factors or running ESG-based strategies, filter
      the universe to tickers with continuous ESG scores to avoid lookahead
      bias and ensure consistent factor construction.

io:
  inputs:
    - name: esg_scores
      required: true
      type:
        domain: esg
        asset_class: equity
        subdomain: scores
        region: null
        frequency: null
      description: |
        Curated ESG scores (E, S, G pillars + composite).

        Expected columns:
          - ticker: Stock ticker symbol
          - date: ESG score date
          - esg_score: Composite ESG score (0-100)
          - (optional) e_score, s_score, g_score

        Partitions: None (load all available)

    - name: membership_data
      required: true
      type:
        domain: membership
        asset_class: null
        subdomain: daily
        region: null
        frequency: null
      description: |
        Universe membership data (daily snapshots).

        Expected columns:
          - date: Trading date
          - ticker: Stock ticker symbol
          - universe: Universe name (e.g., "sp500")

        Partitions: universe={universe}, mode=daily

  output:
    type:
      domain: derived-metrics
      asset_class: equity
      subdomain: universe_filter
      region: null
      frequency: null
    description: |
      Filtered universe with ESG coverage metrics.

      One row per ticker with:
        - Coverage statistics (ESG count, percentage, gaps)
        - Filter decision (passed/failed)
        - Filter reason (diagnostic message)

      Use this output to:
        1. Identify tickers for ESG factor construction
        2. Audit data quality for research
        3. Document universe selection criteria

parameters:
  # Research period
  start_date:
    type: date
    required: true
    description: |
      Research period start date (ISO format: YYYY-MM-DD).

      ESG coverage will be assessed from this date forward.

      Examples:
        - "2014-01-01": Start of 2014
        - "2020-01-01": Start of 2020

  end_date:
    type: date
    required: true
    description: |
      Research period end date (ISO format: YYYY-MM-DD).

      ESG coverage will be assessed up to this date.

      Examples:
        - "2014-12-31": End of 2014
        - "2024-12-31": End of 2024

  universe:
    type: string
    default: "sp500"
    allowed: ["sp500", "russell1000", "custom"]
    description: |
      Universe name to filter.

      Currently supported:
        - "sp500": S&P 500 constituents
        - "russell1000": Russell 1000 (future)
        - "custom": Custom ticker list (future)

      The model will load membership data for this universe
      during the research period.

  # Coverage thresholds
  min_coverage_pct:
    type: float
    default: 0.90
    min: 0.50
    max: 1.0
    description: |
      Minimum ESG coverage percentage to pass filter.

      Coverage = (actual ESG observations) / (expected ESG observations)

      ESG scores are typically published monthly or quarterly.
      For a 1-year period:
        - Monthly ESG: expect ~12 observations
        - Quarterly ESG: expect ~4 observations

      Recommended:
        - 0.90 (90%): Standard for most research (10-11/12 months)
        - 0.80 (80%): Relaxed for longer periods
        - 1.00 (100%): Strict (no missing data)

      Example (1-year period, monthly ESG):
        - 0.90 threshold: requires ≥11 ESG observations
        - 0.80 threshold: requires ≥10 ESG observations

  max_gap_days:
    type: int
    default: 90
    min: 30
    max: 365
    description: |
      Maximum allowed gap between ESG observations (days).

      If any gap exceeds this threshold, ticker fails filter.

      ESG scores are typically updated:
        - Monthly: ~30 days
        - Quarterly: ~90 days
        - Annually: ~365 days

      Recommended:
        - 90 days: Standard (allows quarterly ESG)
        - 60 days: Stricter (monthly ESG preferred)
        - 120 days: Relaxed (accept longer gaps)

      Note: This ensures no large gaps that could cause
            interpolation issues in factor construction.

  require_continuous:
    type: bool
    default: true
    description: |
      Require continuous ESG coverage (no large gaps).

      true:  Enforce max_gap_days threshold
             Reject tickers with gaps > max_gap_days

      false: Only check overall coverage percentage
             Allow large gaps as long as min_coverage_pct met

      Recommendation:
        - true for factor-based research (avoid interpolation)
        - false for cross-sectional studies (snapshots)

  esg_frequency:
    type: enum
    default: "monthly"
    allowed: ["monthly", "quarterly", "annual", "auto"]
    description: |
      Expected ESG publication frequency.

      Used to calculate expected_esg_points:
        - monthly: 12 points per year
        - quarterly: 4 points per year
        - annual: 1 point per year
        - auto: Detect from data (median gap)

      Most ESG providers publish monthly or quarterly.

      Recommended: "auto" to detect actual frequency

  # Universe scope
  membership_mode:
    type: enum
    default: "any_time"
    allowed: ["any_time", "continuous", "end_of_period"]
    description: |
      Universe membership requirement.

      any_time (default):
        Include ALL tickers that were universe members at ANY point
        during research period. Eliminates survivorship bias.

      continuous:
        Include only tickers with CONTINUOUS membership throughout
        entire research period (no additions/removals).

      end_of_period:
        Include only tickers that were members at END of period.
        (Introduces survivorship bias - not recommended)

      Recommendation: "any_time" for most research

  # Output options
  include_failed:
    type: bool
    default: true
    description: |
      Include failed tickers in output.

      true:  Output includes all tickers (passed + failed)
             Use for diagnostic analysis and reporting

      false: Output only tickers that passed filter
             Use when chaining to downstream models

      Recommendation: true for transparency, filter on
                      'passed_filter' column downstream

  verbose_logging:
    type: bool
    default: true
    description: |
      Enable detailed logging of coverage analysis.

      true:  Log per-ticker coverage statistics
      false: Log only summary statistics

      Useful for debugging data quality issues.
