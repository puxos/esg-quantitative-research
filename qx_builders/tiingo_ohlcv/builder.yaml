builder:
  id: tiingo_ohlcv_builder
  version: 1.0.0
  description: "Tiingo OHLCV price data builder - fetches equity price data from Tiingo API"

io:
  output:
    type:
      domain: market-data
      asset_class: equity
      subdomain: bars
      frequency: null  # Partitioned separately

parameters:
  # Required parameters (no defaults)
  symbols:
    type: list
    required: true
    description: "List of ticker symbols to fetch (e.g., ['AAPL', 'MSFT', 'GOOGL'])"

  # Date range
  start_date:
    type: string
    required: false
    default: "2020-01-01"
    description: "Start date for fetching price data (ISO format YYYY-MM-DD)"

  end_date:
    type: string
    required: false
    default: null
    description: "End date for fetching price data (ISO format YYYY-MM-DD). null = today"

  # Data configuration
  frequency:
    type: enum
    required: false
    default: "daily"
    allowed: ["daily", "weekly", "monthly", "yearly"]
    description: "Data frequency for OHLCV prices"

  exchange:
    type: string
    required: false
    default: "US"
    description: "Exchange identifier (US, NYSE, NASDAQ, HK)"

  currency:
    type: string
    required: false
    default: "USD"
    description: "Currency code (USD, HKD)"

  write_mode:
    type: enum
    default: "overwrite"
    allowed: ["append", "overwrite"]
    description: "Write mode - overwrite deletes existing files, append keeps them"

  # Optional features
  market_proxy_symbols:
    type: list
    required: false
    default: ["SPY"]
    description: "Market proxy symbols automatically included in fetch batch"

  use_ticker_mapper:
    type: bool
    required: false
    default: true
    description: "Enable ticker resolution for corporate actions (FB→META, CBS→PARA)"

  # API authentication
  tiingo_api_key:
    type: string
    required: false
    default: null
    description: "Tiingo API key (or use TIINGO_API_KEY env var)"

  # Advanced options
  fail_on_error:
    type: bool
    required: false
    default: false
    description: "Stop build if any symbol fails (false = skip and continue)"

  apply_date_correction:
    type: bool
    required: false
    default: true
    description: "Apply date tolerance buffer for trading day alignment"

  tolerance_days:
    type: int
    required: false
    default: null
    description: "Custom tolerance in days (null = auto: daily=2, weekly=6, monthly=3)"

partitions:
  required: [exchange, frequency]
  defaults:
    exchange: US
    frequency: daily

examples:
  - description: "Fetch daily prices for tech stocks (2020-2024)"
    partitions:
      exchange: US
      frequency: daily
    overrides:
      symbols: ["AAPL", "MSFT", "GOOGL", "AMZN", "META"]
      start_date: "2020-01-01"
      end_date: "2024-12-31"

  - description: "Fetch monthly prices with custom tolerance"
    partitions:
      exchange: US
      frequency: monthly
    overrides:
      symbols: ["SPY", "VTI"]
      start_date: "2014-01-01"
      end_date: "2024-12-31"
      tolerance_days: 5
